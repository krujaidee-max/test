<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡πÄ‡∏Å‡∏° : ‡∏ï‡∏∞‡∏•‡∏∏‡∏¢‡∏≠‡∏ß‡∏Å‡∏≤‡∏® ‡∏Ñ‡∏≥ 3 ‡∏ä‡∏ô‡∏¥‡∏î</title>
<style>
/* ===== ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤ ===== */
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNew.woff2') format('woff2'),
       url('image/THSarabunNew.woff') format('woff'),
       url('image/THSarabunNew.ttf') format('truetype');
  font-weight: 400; font-style: normal; font-display: swap;
}
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNewBold.woff2') format('woff2'),
       url('image/THSarabunNewBold.woff') format('woff'),
       url('image/THSarabunNewBold.ttf') format('truetype');
  font-weight: 700; font-style: normal; font-display: swap;
}
html, body, button, input, select, textarea, .pill, .btn, .btn-mini,
.levelBtn, #startTitle, #countdown, .label, #timer {
  font-family: 'MyGameFont', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
}

/* ===== ‡∏ò‡∏µ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏∏‡∏î‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ===== */
:root{ --glass: rgba(0,0,0,.45); --ok:#10b981; --bad:#ef4444; }
*{ box-sizing:border-box }
html,body{ height:100%; margin:0; }
body{
  background: url("image/background2.png") center center / cover no-repeat fixed !important;
  overflow:hidden; color:#fff;
}
#game{ position:relative; width:100vw; height:100vh; overflow:hidden }

/* === offsets ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï === */
:root{
  --score-offset-x: -30px;   /* + ‡∏Ç‡∏ß‡∏≤ / - ‡∏ã‡πâ‡∏≤‡∏¢ */
  --score-offset-y: -2px;    /* + ‡∏•‡∏á  / - ‡∏Ç‡∏∂‡πâ‡∏ô */
  --comet-offset-x: 100px;   /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï‡πÅ‡∏Å‡∏ô X */
  --comet-offset-y: 60px;    /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï‡πÅ‡∏Å‡∏ô Y */
}

/* ‡∏Ç‡∏¢‡∏±‡∏ö pill ‚Äú‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
#scorePill{ transform: translate(var(--score-offset-x), var(--score-offset-y)); }

/* ===== HUD ===== */
.hud{
  position:fixed; inset:26px 12px auto 38px;
  display:flex; align-items:center; gap:12px; justify-content:space-between; pointer-events:none
}
.hud .left,.hud .right{ display:flex; align-items:center; gap:12px }
.pill{ background:var(--glass); backdrop-filter:blur(6px); padding:8px 12px; border-radius:999px; box-shadow:0 4px 18px rgba(0,0,0,.25) }
#timer{ font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.5px; font-size:20px }
.icon img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 4px 10px rgba(0,0,0,.6)); border-radius:8px }
.stack{ display:flex; flex-direction:column; gap:8px; align-items:flex-start }
.btn-mini{ pointer-events:auto; background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.btn-mini:hover{ filter:brightness(1.1) }

/* ===== ‡∏à‡∏±‡∏î HUD ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ + ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‚Üí‡∏•‡πà‡∏≤‡∏á ===== */
.hud .right { align-items: flex-end; }
.hud .right .stack { align-items: flex-end; }
.hud .right .col{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
.hud .right .pill{ text-align:right; }

/* ===== ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á) ===== */
#startScreen{
  position:fixed; inset:0; display:none;
  flex-direction:column; align-items:center; justify-content:center;
  background:rgba(0,0,0,.9); z-index:9999; text-align:center; padding:24px
}
#startTitle{ font-size:clamp(26px,5vw,48px); font-weight:900; margin-bottom:10px }
#startBtn{
  margin-top:12px; padding:10px 18px; border:0; border-radius:12px; font-weight:800; cursor:pointer; background:#1f2937; color:#fff
}
#startBtn:hover{ filter:brightness(1.1) }
#countdown{ display:none; font-size:clamp(56px,12vw,120px); font-weight:1000; line-height:1; margin-top:8px }

/* ===== Landing: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô + ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ===== */
#landing{
  position: fixed; inset: 0;
  display: flex; flex-direction: column; gap: 22px;
  align-items: center; justify-content: center;
  background: url("image/background2.png") center/cover no-repeat fixed !important;
  z-index: 20000; transition: opacity .3s ease;
}
#landing.hide{ opacity: 0; pointer-events: none; visibility: hidden; }
#landing .brand{ width: min(92vw, 1100px); }
#landing .brand img{ width:100%; height:auto; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)); }
.level-menu{ display:flex; flex-direction:column; gap:14px; width:min(92vw, 640px); }
.levelBtn{
  width:100%; padding: 10px 16px;
  font-size: clamp(20px, 4vw, 34px); font-weight: 1000; letter-spacing:.2px;
  border: 0; border-radius: 14px; color: #fff; background: rgba(0,0,0,.55);
  box-shadow: 0 10px 28px rgba(0,0,0,.35); cursor: pointer; text-align:center;
  border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(6px);
}
.levelBtn:hover{ filter: brightness(1.08); }
.levelBtn:active{ transform: translateY(1px); }

/* ===== ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ===== */
#guideScreen{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:url("image/background2.png") center/cover no-repeat;
  z-index: 20001;
}
#guideScreen .guide-wrap{
  width:min(95vw, 1200px);
  max-height:92vh;
  display:flex; flex-direction:column; gap:10px;
  align-items:center; justify-content:center;
}
#guideScreen img{
  width:100%; height:auto; max-height:92vh;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  display:block;
}
#guideScreen .guide-close{
  align-self:flex-end; margin-top:8px;
  background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer;
}
#guideScreen .guide-close:hover{ filter:brightness(1.1) }

/* ===== ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏à‡∏ö‡πÄ‡∏Å‡∏° ===== */
#overlay{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); visibility:hidden; opacity:0; transition:.25s; z-index:9999 }
#overlay.show{ visibility:visible; opacity:1 }
.panel{ background:rgba(20,20,20,.9); border:1px solid rgba(255,255,255,.1); padding:22px 26px; border-radius:20px; min-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.5) }
.panel h1{ margin:0 0 6px; font-size:28px }
.panel p{ margin:8px 0 18px; opacity:.85 }
.btn{ background:#1f2937; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer }
.btn:hover{ filter:brightness(1.1) }
.actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
#overlay .btn { padding: 12px 24px; font-size: 20px; font-weight: 900; border-radius: 18px; min-width: 180px; }
#restartBtn { background:#1f2937; } #restartBtn:hover{ filter:brightness(1.1) }
#selectLevelBtn { background:#2563eb; } #selectLevelBtn:hover{ background:#1d4ed8 }
#nextLevelBtn { background:#10b981; } #nextLevelBtn:hover{ background:#059669 }
.wrong-box{ margin-top:14px; text-align:left; display:none; }
.wrong-title{ font-weight:900; font-size:30px; margin-bottom:8px }
.wrong-list{ display:flex; flex-wrap:wrap; gap:8px; max-height:140px; font-size:28px; overflow:auto }
.chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; font-weight:700 }
.muted{ opacity:.7 }

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô +/- ===== */
.float{ position:fixed; left:0; top:0; pointer-events:none; font-weight:800; font-size:24px; text-shadow:0 2px 8px rgba(0,0,0,.5) }
@keyframes rise{ 0%{ transform:translate(-50%,-10px); opacity:0 } 15%{ opacity:1 } 100%{ transform:translate(-50%,-70px); opacity:0 } }

/* ===== ‡πÄ‡∏£‡∏∑‡∏≠‡∏≠‡∏ß‡∏Å‡∏≤‡∏® ===== */
#ship{
  position:fixed;
  left:50%; bottom:24px;
  width:280px; height:280px;
  background:url("image/ship.png") center/contain no-repeat;
  transform:translateX(-50%) rotate(0deg);
  transform-origin:50% 75%;
  pointer-events:none;
  z-index:8001;
}

/* ===== ‡∏≠‡∏∏‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ===== */
.comet{
  position:absolute; top:-160px;
  width:var(--size,110px); height:var(--size,110px);
  background-image:url("image/comet.png");
  background-size:100% 100%; background-repeat:no-repeat;
  filter:drop-shadow(0 10px 22px rgba(0,0,0,.6));
  cursor:crosshair; user-select:none; will-change:transform,opacity;
}
.comet .label{
  position:absolute; inset:0; display:grid; place-items:center;
  font-weight:800; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.8);
  font-size: calc(var(--size) / 6); pointer-events:none;
}
/* ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏•‡∏π‡∏Å‡πÄ‡∏£‡πá‡∏ß */
.comet.fast{
  filter:
    drop-shadow(0 0 22px rgba(255,215,0,.65))
    drop-shadow(0 10px 22px rgba(0,0,0,.6));
}
.piece{
  position:fixed; width:14px; height:14px; opacity:1; pointer-events:none;
  background-image:url("image/comet.png"); background-repeat:no-repeat;
  background-size:var(--csizeW) var(--csizeH);
}
@keyframes blast{ to{ transform:translate(var(--dx),var(--dy)) rotate(var(--rot)); opacity:0 } }

/* (‡∏ã‡πà‡∏≠‡∏ô kid/acceptBox ‡πÄ‡∏î‡∏¥‡∏°) */
#kid, #acceptBox { display:none !important; }

@media (max-width:480px){
  #timer{ font-size:20px }
}

/* ‡πÉ‡∏´‡πâ HUD ‡∏•‡∏≠‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ landing (20000) */
.hud{ z-index: 22001; }

/* ===== ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤-‡∏ö‡∏ô: ‡∏£‡∏π‡∏õ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ===== */
#game::after{
  content:"";
  position: fixed;
  top: 0; right: 0;
  width: var(--corner2-img-w, 200px);
  height: var(--corner2-img-h, 200px);
  background: url("image/button2.png") no-repeat right top / contain;
  pointer-events: none;
  z-index: 21000;
  opacity: 1;
}
body::after{
  content:"";
  position: fixed;
  top: 0; left: 0;
  width: var(--corner-img-w, 260px);
  height: var(--corner-img-h, 260px);
  background: url("image/button1.png") no-repeat left top / contain;
  pointer-events: none;
  z-index: 21000;
}

/* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï‡∏Ç‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
.hud .right .icon { display: none !important; }

/* ==== ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏Å + ‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™‡∏£‡∏≠‡∏¢‡∏ü‡∏≤‡∏î ==== */
#cameraMirror{
  position:fixed; inset:0;
  width:100vw; height:100vh;
  object-fit:cover;
  transform: scaleX(-1);       /* ‡∏Å‡∏£‡∏∞‡∏à‡∏Å */
  z-index: 1;                  /* ‡πÉ‡∏ï‡πâ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏°/‡∏Æ‡∏±‡∏î */
  display:none;                /* ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
  background:#000;
}

/* ==== ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å (‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÅ‡∏ï‡πà‡πÉ‡∏ï‡πâ HUD) ==== */
#headCanvas{
  position:fixed; inset:0;
  width:100vw; height:100vh;
  z-index: 21490;           /* HUD=22001, ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå=21500 */
  pointer-events:none;
  display:none;             /* ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß */
}

/* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ô‡πà ‡πÜ */
#game{ z-index: 3; position:relative; }

/* === Override z-index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏ï‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏≠‡∏¢ === */
.float{
  position:fixed; left:0; top:0;
  pointer-events:none;
  font-weight:800; font-size:24px;
  text-shadow:0 2px 8px rgba(0,0,0,.5);
  z-index: 21500;            /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ #game / ‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û ‡πÅ‡∏ï‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ HUD */
}
.piece{
  position:fixed; width:14px; height:14px; opacity:1; pointer-events:none;
  background-image:url("image/comet.png"); background-repeat:no-repeat;
  background-size:var(--csizeW) var(--csizeH);
  z-index: 21500;            /* ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
}

/* ‚Üì ‡∏Ç‡∏¢‡∏±‡∏ö‡∏¢‡∏≤‡∏ô‡∏•‡∏á‡∏°‡∏≤‡∏≠‡∏µ‡∏Å (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô) */
#ship{
  bottom: -50px;   /* ‡πÄ‡∏î‡∏¥‡∏° 24px ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à ‡πÄ‡∏ä‡πà‡∏ô 0px, 8px, 12px */
}
@media (max-width: 480px){
  #ship{ bottom: -10px; }  /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
}


</style>
</head>
<body>
<!-- ==== AR Mirror (‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏Å + ‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™‡∏ß‡∏≤‡∏î‡∏£‡∏≠‡∏¢‡∏ü‡∏≤‡∏î) ==== -->

<video id="cameraMirror" playsinline muted></video>
<canvas id="headCanvas"></canvas>
  <div id="game" aria-label="‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°">
    <div id="kid" aria-hidden="true">
      <div id="acceptBox"><div class="txt" id="ruleLabel">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div></div>
    </div>
  </div>

  <!-- ===== Landing: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ===== -->
  <div id="landing" role="dialog" aria-modal="true">
    <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
    <div class="level-menu">
      <button class="levelBtn" data-level="0">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1 : ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°‚Äù</button>
      <button class="levelBtn" data-level="1">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 2 : ‚Äú‡∏Ñ‡∏≥‡∏Å‡∏£‡∏¥‡∏¢‡∏≤‚Äù</button>
      <button class="levelBtn" data-level="2">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 3 : ‚Äú‡∏Ñ‡∏≥‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏ì‡πå‚Äù</button>
      <button class="levelBtn" id="guideBtn">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô üìñ</button>
    </div>
  </div>

  <!-- ===== ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ===== -->
  <div id="startScreen">
    <div id="startTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ‚Äú‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‚Äù ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
    <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
    <div id="countdown">3</div>
  </div>

  <!-- ===== ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ===== -->
  <div id="guideScreen">
    <div class="guide-wrap">
      <img src="image/guide.png" alt="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡∏°">
      <button id="guideBack" class="btn-mini guide-close">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <!-- ===== HUD ===== -->
  <div class="hud">
    <div class="left">
      <div class="stack">
        <div class="pill" id="timer">02:00</div>
        <div style="display:flex; gap:8px;">
          <button id="pauseBtn" class="btn-mini">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
          <button id="quickRestart" class="btn-mini">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
<!-- üé§ Voice Toggle -->
<div style="display:flex; gap:8px; align-items:center;">
  <button id="micBtn" class="btn-mini" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î</button>
  <div id="voicePill" class="pill" style="display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶</div>
<button id="camBtn" class="btn-mini" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Å‡∏•‡πâ‡∏≠‡∏á AR">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏õ‡∏¥‡∏î</button>
</div>
      </div>
    </div>
    <div class="right">
      <div class="stack" style="align-items:flex-end">
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="icon pill" style="padding:4px 8px">
            <img src="image/comet.png" alt="comet">
          </div>
          <div class="pill" id="scorePill">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ‡∏¢‡∏≤‡∏ô ===== -->
  <div id="ship" aria-hidden="true"></div>

  <!-- ===== ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏à‡∏ö‡πÄ‡∏Å‡∏° ===== -->
  <div id="overlay">
    <div class="panel">
      <h1 id="endTitle">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!</h1>
      <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: <b id="finalScore">0</b></p>
      <p id="accumSummary" style="display:none; color:#ffd700; font-weight:900;">
        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏° (3 ‡∏£‡∏≠‡∏ö): <b id="accumTotal">0</b>
      </p>
      <div class="wrong-box">
        <div class="wrong-title">‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡∏á‡∏û‡∏•‡∏≤‡∏î (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤)</div>
        <div id="wrongList" class="wrong-list"></div>
      </div>
      <div class="actions">
        <button class="btn" id="restartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        <button class="btn" id="selectLevelBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô</button>
        <button class="btn" id="nextLevelBtn">‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

  <!-- ===== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ===== -->
  <audio id="hitSound" preload="auto"></audio>
  <audio id="winSound" preload="auto"></audio>
  <audio id="bgm" preload="auto" loop></audio>

  <!-- ===== ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen ===== -->
  <button id="muteBtn" aria-pressed="false" title="Mute / Unmute"
    style="position:fixed; right:12px; bottom:12px; width:44px; height:44px; border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.3); color:#fff; font-size:18px; line-height:1; display:grid; place-items:center; cursor:pointer; z-index:10000;">üîä</button>

  <button id="fsBtn" aria-pressed="false" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠"
    style="position:fixed; right:12px; bottom:62px; width:44px; height:44px; border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.3); color:#fff; font-size:18px; line-height:1; display:grid; place-items:center; cursor:pointer; z-index:10000;">‚õ∂</button>

  <!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Mute ===== -->
  <script>
  (function(){
    const muteBtn = document.getElementById('muteBtn');
    if(!muteBtn) return;
    let isMuted = false;
    function applyMute(m){
      isMuted = !!m;
      document.querySelectorAll('audio').forEach(a => {
        a.muted = isMuted;
        if(isMuted){ a.setAttribute('muted',''); } else { a.removeAttribute('muted'); }
      });
      muteBtn.setAttribute('aria-pressed', String(isMuted));
      muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
    }
    muteBtn.addEventListener('click', () => applyMute(!isMuted));
  })();
  </script>

  <!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Fullscreen ===== -->
  <script>
  (function(){
    const fsBtn = document.getElementById('fsBtn');
    if (!fsBtn) return;

    function fsEnabled(){
      return document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled;
    }
    function isFull(){
      return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
    }
    function requestFS(){
      const el = document.documentElement;
      const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
      req && req.call(el);
    }
    function exitFS(){
      const ex = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
      ex && ex.call(document);
    }
    function render(){
      const on = !!isFull();
      fsBtn.setAttribute('aria-pressed', String(on));
      fsBtn.title = on ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠';
      fsBtn.textContent = on ? 'üóó' : '‚õ∂';
    }

    if (!fsEnabled()){
      fsBtn.style.display = 'none';
      return;
    }

    fsBtn.addEventListener('click', () => {
      if (isFull()) exitFS(); else requestFS();
    });

    document.addEventListener('fullscreenchange', render);
    document.addEventListener('webkitfullscreenchange', render);
    document.addEventListener('msfullscreenchange', render);
    render();
  })();
  </script>

  <!-- ===== ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏° ===== -->
  <script>
  (() => {
    /* ---------- DOM refs ---------- */
    const game = document.getElementById('game');
    const timerEl = document.getElementById('timer');
    const overlay = document.getElementById('overlay');
    const endTitleEl = document.getElementById('endTitle');
    const finalScoreEl = document.getElementById('finalScore');
    const restartBtn = document.getElementById('restartBtn');
    const quickRestart = document.getElementById('quickRestart');
    const selectLevelBtn = document.getElementById('selectLevelBtn');
    const nextLevelBtn = document.getElementById('nextLevelBtn');
    const wrongListEl = document.getElementById('wrongList');
    const wrongBoxEl = document.querySelector('.wrong-box');

    const scoreEl = document.getElementById('score');

    const hitSound = document.getElementById('hitSound');
    const winSound = document.getElementById('winSound');
    const bgm = document.getElementById('bgm');

    if (hitSound) { hitSound.src = "image/audio1.mp3"; hitSound.volume = 0.8; }
    if (winSound) { winSound.src = "image/win2.mp3";  winSound.volume = 1.0; }
    if (bgm)      { bgm.src = "image/bgm3.mp3";       bgm.volume = 0.35; }

    /* ---------- ‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥: ‡∏ô‡∏≤‡∏°/‡∏Å‡∏£‡∏¥‡∏¢‡∏≤/‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏ì‡πå ---------- */
    const NOUNS = [ "‡∏Ñ‡∏£‡∏π","‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏´‡∏°‡∏≠","‡∏ï‡∏≥‡∏£‡∏ß‡∏à","‡∏ó‡∏´‡∏≤‡∏£","‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤","‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤","‡∏Ñ‡∏ô‡∏™‡∏ß‡∏ô","‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤","‡∏ä‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏á",
      "‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤","‡∏ô‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏á","‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á","‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô","‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£","‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á","‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô","‡∏û‡∏µ‡πà","‡∏ô‡πâ‡∏≠‡∏á","‡∏û‡πà‡∏≠",
      "‡πÅ‡∏°‡πà","‡∏•‡∏π‡∏Å","‡∏õ‡∏π‡πà","‡∏¢‡πà‡∏≤","‡∏ï‡∏≤","‡∏¢‡∏≤‡∏¢","‡∏´‡∏•‡∏≤‡∏ô","‡∏•‡∏∏‡∏á","‡∏õ‡πâ‡∏≤","‡∏ô‡πâ‡∏≤",
      "‡πÅ‡∏°‡∏ß","‡∏´‡∏°‡∏≤","‡∏°‡πâ‡∏≤","‡∏ß‡∏±‡∏ß","‡∏Ñ‡∏ß‡∏≤‡∏¢","‡πÅ‡∏û‡∏∞","‡πÅ‡∏Å‡∏∞","‡∏´‡∏°‡∏π","‡πÑ‡∏Å‡πà","‡πÄ‡∏õ‡πá‡∏î",
      "‡∏õ‡∏•‡∏≤","‡∏Å‡∏∏‡πâ‡∏á","‡∏õ‡∏π","‡∏´‡∏≠‡∏¢","‡∏á‡∏π","‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ","‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏Å","‡∏ï‡∏∏‡πä‡∏Å‡πÅ‡∏Å","‡∏ô‡∏Å","‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠",
      "‡∏¢‡∏∏‡∏á","‡∏°‡∏î","‡πÅ‡∏°‡∏•‡∏á‡∏™‡∏≤‡∏ö","‡∏ï‡∏±‡πä‡∏Å‡πÅ‡∏ï‡∏ô","‡∏ï‡∏∏‡πà‡∏ô","‡∏´‡∏ô‡∏π","‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢","‡∏ä‡πâ‡∏≤‡∏á","‡∏™‡∏¥‡∏á‡πÇ‡∏ï","‡πÄ‡∏™‡∏∑‡∏≠",
      "‡πÇ‡∏ï‡πä‡∏∞","‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ","‡πÄ‡∏ï‡∏µ‡∏¢‡∏á","‡∏ï‡∏π‡πâ","‡∏ó‡∏µ‡∏ß‡∏µ","‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô","‡∏û‡∏±‡∏î‡∏•‡∏°","‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå","‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå","‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
      "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤","‡∏î‡∏¥‡∏ô‡∏™‡∏≠","‡∏¢‡∏≤‡∏á‡∏•‡∏ö","‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î","‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤","‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤","‡πÄ‡∏™‡∏∑‡πâ‡∏≠","‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á","‡∏´‡∏°‡∏ß‡∏Å","‡πÅ‡∏ß‡πà‡∏ô‡∏ï‡∏≤",
      "‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤","‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå","‡∏£‡∏ñ‡πÑ‡∏ñ","‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô","‡∏à‡∏≤‡∏ô","‡∏ä‡πâ‡∏≠‡∏ô","‡∏™‡πâ‡∏≠‡∏°","‡πÅ‡∏Å‡πâ‡∏ß","‡∏´‡∏°‡πâ‡∏≠","‡∏°‡∏µ‡∏î",
      "‡∏ö‡πâ‡∏≤‡∏ô","‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏•‡∏¢","‡∏ï‡∏•‡∏≤‡∏î","‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•","‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£","‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô","‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏µ‡∏¨‡∏≤",
      "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à","‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô","‡πÇ‡∏£‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå","‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£","‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥","‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß","‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î",
      "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°","‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®","‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô","‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡∏ó‡∏∞‡πÄ‡∏•","‡∏ô‡πâ‡∏≥‡∏ï‡∏Å","‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥","‡∏ñ‡∏ô‡∏ô","‡∏ã‡∏≠‡∏¢",
      "‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô","‡πÄ‡∏°‡∏∑‡∏≠‡∏á","‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®","‡πÇ‡∏•‡∏Å","‡∏ó‡∏∏‡∏á‡∏ó‡∏∏‡∏á‡∏ó‡∏∏‡∏á ‡∏ã‡∏≤‡∏Æ‡∏π‡∏£‡πå" ];
    const VERBS = [ "‡∏Å‡∏¥‡∏ô","‡πÄ‡∏î‡∏¥‡∏ô","‡∏ô‡∏≠‡∏ô","‡∏ô‡∏±‡πà‡∏á","‡∏ß‡∏¥‡πà‡∏á","‡∏¢‡∏∑‡∏ô","‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô","‡∏≠‡πà‡∏≤‡∏ô","‡∏ß‡∏≤‡∏î","‡∏û‡∏π‡∏î","‡∏ü‡∏±‡∏á","‡∏î‡∏π","‡∏£‡πâ‡∏≠‡∏á","‡πÄ‡∏ï‡πâ‡∏ô","‡πÄ‡∏•‡πà‡∏ô","‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
      "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏™‡∏≠‡∏ô","‡∏ä‡πà‡∏ß‡∏¢","‡∏ã‡∏∑‡πâ‡∏≠","‡∏Ç‡∏≤‡∏¢","‡∏ö‡∏≠‡∏Å","‡∏ñ‡∏≤‡∏°","‡∏ï‡∏≠‡∏ö","‡πÄ‡∏Å‡πá‡∏ö","‡∏•‡πâ‡∏≤‡∏á","‡∏≠‡∏≤‡∏ö","‡∏Ç‡∏±‡∏ö","‡∏Ç‡∏µ‡πà","‡∏Ç‡πâ‡∏≤‡∏°","‡∏ß‡πà‡∏≤‡∏¢","‡∏û‡∏±‡∏ö","‡∏ï‡∏≤‡∏Å","‡∏Å‡∏ß‡∏≤‡∏î",
      "‡∏ñ‡∏π","‡∏´‡∏¢‡∏¥‡∏ö","‡∏¢‡∏Å","‡∏ß‡∏≤‡∏á","‡∏£‡∏±‡∏ö","‡∏™‡πà‡∏á","‡πÄ‡∏õ‡∏¥‡∏î","‡∏õ‡∏¥‡∏î","‡πÄ‡∏ó","‡∏ï‡∏±‡∏Å","‡πÅ‡∏Å‡∏∞","‡πÅ‡∏Ñ‡∏∞","‡πÄ‡∏Å‡∏≤","‡∏Ç‡∏µ‡∏î","‡∏ñ‡∏±‡∏Å","‡∏ó‡∏≠","‡∏ú‡∏π‡∏Å","‡πÅ‡∏Å‡πâ","‡∏£‡∏±‡∏î","‡∏û‡πà‡∏ô","‡πÄ‡∏õ‡πà‡∏≤",
      "‡∏û‡∏∏‡πà‡∏á","‡∏Ç‡∏ß‡πâ‡∏≤‡∏á","‡∏¢‡∏¥‡∏á","‡∏´‡∏•‡∏ö","‡∏ã‡πà‡∏≠‡∏ô","‡∏õ‡∏µ‡∏ô","‡∏Ç‡∏∏‡∏î","‡∏Ç‡∏∏‡∏î","‡πÑ‡∏ñ","‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß","‡∏´‡∏ß‡πà‡∏≤‡∏ô","‡∏î‡∏≥","‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß",
      "‡∏Ç‡∏ô","‡∏¢‡πâ‡∏≤‡∏¢","‡πÅ‡∏ö‡∏Å","‡∏´‡∏≤‡∏°","‡∏•‡∏≤‡∏Å","‡∏ñ‡∏π","‡∏û‡∏±‡∏ö","‡∏ñ‡∏ß‡∏≤‡∏¢","‡∏Å‡∏£‡∏≤‡∏ö","‡πÑ‡∏´‡∏ß‡πâ","‡∏ö‡∏π‡∏ä‡∏≤","‡∏ô‡∏±‡∏ö","‡∏ó‡∏≠‡∏î","‡∏ä‡∏±‡πà‡∏á","‡∏ï‡∏ß‡∏á","‡∏ö‡∏ß‡∏Å","‡∏•‡∏ö","‡∏Ñ‡∏π‡∏ì","‡∏´‡∏≤‡∏£",
      "‡∏™‡∏£‡πâ‡∏≤‡∏á","‡∏ã‡πà‡∏≠‡∏°","‡∏£‡∏∑‡πâ‡∏≠","‡∏û‡∏±‡∏á","‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå","‡∏ó‡∏≥‡∏•‡∏≤‡∏¢" ];
    const ADVERBS = [ "‡∏î‡∏µ","‡∏ä‡∏±‡πà‡∏ß","‡∏™‡∏ß‡∏¢","‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å","‡∏≠‡πâ‡∏ß‡∏ô","‡∏ú‡∏≠‡∏°","‡∏™‡∏π‡∏á","‡∏ï‡πà‡∏≥","‡πÄ‡∏ï‡∏µ‡πâ‡∏¢","‡πÉ‡∏´‡∏ç‡πà","‡πÄ‡∏•‡πá‡∏Å","‡∏Å‡∏ß‡πâ‡∏≤‡∏á","‡πÅ‡∏Ñ‡∏ö","‡∏´‡∏ô‡∏±‡∏Å","‡πÄ‡∏ö‡∏≤","‡∏Ñ‡∏°","‡πÄ‡∏´‡∏°‡πá‡∏ô",
      "‡∏£‡πâ‡∏≠‡∏ô","‡πÄ‡∏¢‡πá‡∏ô","‡πÅ‡∏Ç‡πá‡∏á","‡∏≠‡πà‡∏≠‡∏ô","‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å","‡πÅ‡∏´‡πâ‡∏á","‡∏™‡∏∞‡∏≠‡∏≤‡∏î","‡∏™‡∏Å‡∏õ‡∏£‡∏Å","‡πÅ‡∏î‡∏á","‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß","‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á","‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô","‡∏î‡∏≥","‡∏Ç‡∏≤‡∏ß","‡∏ä‡∏°‡∏û‡∏π",
      "‡∏°‡πà‡∏ß‡∏á","‡∏™‡πâ‡∏°","‡∏ü‡πâ‡∏≤","‡πÄ‡∏ó‡∏≤","‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•","‡∏ó‡∏≠‡∏á","‡πÄ‡∏á‡∏¥‡∏ô","‡∏°‡∏≤‡∏Å","‡∏ô‡πâ‡∏≠‡∏¢","‡∏´‡∏ô‡∏∂‡πà‡∏á","‡∏™‡∏≠‡∏á","‡∏™‡∏≤‡∏°","‡∏™‡∏¥‡∏ö","‡∏£‡πâ‡∏≠‡∏¢","‡∏û‡∏±‡∏ô","‡∏´‡∏°‡∏∑‡πà‡∏ô","‡πÅ‡∏™‡∏ô","‡∏•‡πâ‡∏≤‡∏ô",
      "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏Ñ‡∏£‡∏∂‡πà‡∏á","‡πÄ‡∏ó‡πà‡∏≤","‡∏´‡∏°‡∏î","‡πÄ‡∏ä‡πâ‡∏≤","‡∏™‡∏≤‡∏¢","‡∏ö‡πà‡∏≤‡∏¢","‡πÄ‡∏¢‡πá‡∏ô","‡∏î‡∏∂‡∏Å","‡∏ô‡∏≤‡∏ô","‡πÄ‡∏£‡πá‡∏ß","‡∏ä‡πâ‡∏≤","‡πÅ‡∏´‡∏•‡∏°","‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ","‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ",
      "‡∏ï‡∏•‡∏≠‡∏î","‡∏ö‡πà‡∏≠‡∏¢","‡∏´‡∏ß‡∏≤‡∏ô","‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß","‡πÄ‡∏Ñ‡πá‡∏°","‡πÄ‡∏ú‡πá‡∏î","‡∏Ç‡∏°","‡∏à‡∏∑‡∏î","‡∏°‡∏±‡∏ô","‡∏ù‡∏≤‡∏î","‡πÄ‡∏ù‡∏∑‡πà‡∏≠‡∏ô","‡∏î‡∏±‡∏á","‡πÄ‡∏ö‡∏≤","‡πÄ‡∏á‡∏µ‡∏¢‡∏ö","‡∏ß‡πà‡∏≠‡∏á‡πÑ‡∏ß",
      "‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡πà‡∏ß","‡∏ä‡πâ‡∏≤‡πÜ","‡πÄ‡∏£‡πá‡∏ß‡πÜ","‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á","‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠","‡∏™‡∏á‡∏ö","‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß","‡∏ß‡∏∏‡πà‡∏ô‡∏ß‡∏≤‡∏¢","‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÉ‡∏Å‡∏•‡πâ","‡πÑ‡∏Å‡∏•","‡∏ö‡∏ô",
      "‡∏•‡πà‡∏≤‡∏á","‡∏ô‡∏≠‡∏Å","‡πÉ‡∏ô","‡∏´‡∏ô‡πâ‡∏≤","‡∏´‡∏•‡∏±‡∏á","‡∏ã‡πâ‡∏≤‡∏¢","‡∏Ç‡∏ß‡∏≤","‡∏Å‡πà‡∏≠‡∏ô","‡∏´‡∏•‡∏±‡∏á","‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡πâ‡∏≤","‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô","‡∏î‡∏∂‡∏Å‡∏î‡∏∑‡πà‡∏ô" ];

    /* ---------- ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô (3 ‡∏î‡πà‡∏≤‡∏ô) ---------- */
    const LEVELS = [
      { id:0, name:"‡∏î‡πà‡∏≤‡∏ô 1", mission:"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡∏¢‡∏¥‡∏á‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏≤‡∏°‚Äù ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", correct:NOUNS, wrong:[...VERBS, ...ADVERBS] },
      { id:1, name:"‡∏î‡πà‡∏≤‡∏ô 2", mission:"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡∏¢‡∏¥‡∏á‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ‚Äú‡∏Ñ‡∏≥‡∏Å‡∏£‡∏¥‡∏¢‡∏≤‚Äù ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", correct:VERBS, wrong:[...NOUNS, ...ADVERBS] },
      { id:2, name:"‡∏î‡πà‡∏≤‡∏ô 3", mission:"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡∏¢‡∏¥‡∏á‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ‚Äú‡∏Ñ‡∏≥‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏ì‡πå‚Äù ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", correct:ADVERBS, wrong:[...NOUNS, ...VERBS] },
    ];
    let selectedLevel = 0;

    /* ---------- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏° = 3 ‡∏£‡∏≠‡∏ö ---------- */
    let cumulativeScore = 0;
    let roundsPlayed   = 0;
    let lastRunScore   = 0;

    function updateAccum(){
      const el = document.getElementById('accumVal');
      if(el) el.textContent = cumulativeScore.toString();
    }
    function refreshNextButton(){
      const sumEl = document.getElementById('accumSummary');
      const totalEl = document.getElementById('accumTotal');
      if (roundsPlayed < 2){
        nextLevelBtn.disabled = false; nextLevelBtn.textContent = '‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'; nextLevelBtn.style.opacity = '1';
        if(sumEl) sumEl.style.display = 'none';
        return;
      }
      if (roundsPlayed === 2){
        nextLevelBtn.disabled = false; nextLevelBtn.textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°'; nextLevelBtn.style.opacity = '1';
        if(sumEl) sumEl.style.display = 'none';
        return;
      }
      nextLevelBtn.disabled = true; nextLevelBtn.textContent = '‡∏Ñ‡∏£‡∏ö 3 ‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'; nextLevelBtn.style.opacity = '0.6';
      if (sumEl && totalEl){ totalEl.textContent = cumulativeScore.toString(); sumEl.style.display = 'block'; }
    }

    /* ---------- ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏°‡∏≠‡∏∏‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï + ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ---------- */
    const stageSeconds = 120;
    const MAX_COMETS = 6;
    const SPAWN_MS = 650;
    const SPEED_MIN = 120, SPEED_MAX = 260;
    const VX_MAX = 140;

    const PROB_CORRECT = 0.40;

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö + ‡∏•‡∏π‡∏Å‡πÄ‡∏£‡πá‡∏ß
    const FAST_VY = 220;
    const CORRECT_NORMAL = 1;
    const CORRECT_FAST   = 2;
    const WRONG_NORMAL   = -1;
    const WRONG_FAST     = -2;

    // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô
    const PASS_SCORE = 30;

    let running = false, ended = false, paused = false;
    let spawner = null, countdown = null;
    let remain = stageSeconds;
    let lastTime = 0;

    let score = 0;
    let clickedWrongWords = [];

    /* ---------- ‡∏¢‡∏π‡∏ó‡∏¥‡∏• ---------- */
    function fmt(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = (sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }
    function floatText(text, x, y, kind){
      const t = document.createElement('div');
      t.className = 'float'; t.textContent = text;
      t.style.left = x+'px'; t.style.top = y+'px';
      t.style.color = (kind==='ok') ? 'var(--ok)' : 'var(--bad)';
      t.style.animation = 'rise 800ms ease-out forwards';
      document.body.appendChild(t);
      t.addEventListener('animationend', () => t.remove(), {once:true});
    }
    function rand(min,max){return Math.random()*(max-min)+min}
    function randInt(min,max){return Math.floor(rand(min,max+1))}

    function playHit(){
      try { const a = hitSound.cloneNode(true); a.volume = 1; a.src = hitSound.src; a.play().catch(()=>{}); } catch(e){}
    }

    // ===== ‡πÄ‡∏î‡πá‡∏Ñ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≥‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô =====
    let correctDeck = [], wrongDeck = [];
    let seenRound = new Set();

    function shuffleInPlace(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = (Math.random() * (i + 1)) | 0;
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function resetDecksForLevel(){
      const L = LEVELS[selectedLevel] || LEVELS[0];
      correctDeck = shuffleInPlace(L.correct.slice());
      wrongDeck   = shuffleInPlace(L.wrong.slice());
      seenRound.clear();
    }

    function drawUnique(fromCorrect){
      const L = LEVELS[selectedLevel] || LEVELS[0];
      let deck = fromCorrect ? correctDeck : wrongDeck;

      let guard = L.correct.length + L.wrong.length + 5;

      while (guard-- > 0){
        if (deck.length === 0){
          if (fromCorrect){ correctDeck = shuffleInPlace(L.correct.slice()); deck = correctDeck; }
          else            { wrongDeck   = shuffleInPlace(L.wrong.slice());   deck = wrongDeck;   }
        }
        const word = deck.pop();
        if (!seenRound.has(word)){
          seenRound.add(word);
          return word;
        }
      }
      return fromCorrect ? (L.correct[0] || '') : (L.wrong[0] || '');
    }

function hitComet(node, atX, atY){
  if(!node || !running) return;
  if(node.dataset.hit) return;
  node.dataset.hit = '1';

  const val  = node.dataset.value === '1';
  const fast = node.dataset.fast  === '1';

  let delta = 0;
  if (val){
    delta = fast ? CORRECT_FAST : CORRECT_NORMAL;
    score += delta;
    scoreEl.textContent = score;
    floatText('+'+delta + (fast?' ‚ö°':''), atX, atY, 'ok');
  }else{
    delta = fast ? WRONG_FAST : WRONG_NORMAL;
    score += delta;
    scoreEl.textContent = score;
    const text = node.querySelector('.label')?.textContent?.trim();
    if(text) clickedWrongWords.push(text);
    floatText(delta.toString(), atX, atY, 'bad');
  }

  if (score >= PASS_SCORE) { endGame('win'); }

// ‡∏´‡∏±‡∏ô‡∏´‡∏±‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏Å‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î
try {
  window.__GAME__?.pointShipToNode?.(node);
} catch(e){}

  shatter(node);
  playHit();
}
    /* ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏∏‡∏Å‡∏≤‡∏ö‡∏≤‡∏ï ---------- */
function spawnComet(){
  if(!running) return;
  if(document.querySelectorAll('.comet').length >= MAX_COMETS) return;

  const size = randInt(220, 320);
  const vy   = rand(SPEED_MIN, SPEED_MAX);
  const vx   = [ -1, 0, 1 ][randInt(0,2)] * rand(40, VX_MAX);
  const startX = randInt(0, Math.max(20, window.innerWidth - size - 20));
  const startY = -size - 40;

  const node = document.createElement('div');
  node.className = 'comet';
  node.style.setProperty('--size', size+'px');
  node.style.left = '0px'; node.style.top = '0px';

  const isFast = vy >= FAST_VY;
  node.dataset.fast = isFast ? '1' : '0';
  if(isFast) node.classList.add('fast');

  const isCorrect = Math.random() < PROB_CORRECT;
  const label = document.createElement('div');
  label.className = 'label';
  if (isCorrect){
    label.textContent = drawUnique(true);
    node.dataset.value = '1';
  } else {
    label.textContent = drawUnique(false);
    node.dataset.value = '0';
  }

  node.dataset.x = startX; node.dataset.y = startY;
  node.dataset.vx = vx;    node.dataset.vy = vy;

  node.appendChild(label);

  // üî• ‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏ô‡∏≠‡∏£‡πå "‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠" ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å hitComet ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏ö
  node.addEventListener('click', (ev) => {
    if(!running) return;
    if(node.dataset.hit) return;
    const r = node.getBoundingClientRect();
    hitComet(
      node,
      ev.clientX ?? (r.left + r.width/2),
      ev.clientY ?? (r.top + r.height/2)
    );
  }, { once:true });

  game.appendChild(node);
  node.style.transform = `translate(calc(${startX}px + var(--comet-offset-x)),
                               calc(${startY}px + var(--comet-offset-y)))`;
}


    /* ---------- ‡πÅ‡∏ï‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ ---------- */
    function shatter(cometEl){
      const rect = cometEl.getBoundingClientRect();
      cometEl.style.opacity = '0'; cometEl.style.pointerEvents = 'none';
      setTimeout(() => cometEl.remove(), 250);

      const piece = Math.max(12, Math.floor(rect.width/6));
      const cols = Math.ceil(rect.width / piece);
      const rows = Math.ceil(rect.height / piece);

      for(let ry=0; ry<rows; ry++){
        for(let rx=0; rx<cols; rx++){
          const p = document.createElement('div');
          p.className = 'piece';
          p.style.setProperty('--csizeW', rect.width+'px');
          p.style.setProperty('--csizeH', rect.height+'px');

          p.style.left = (rect.left + rx*piece)+'px';
          p.style.top  = (rect.top  + ry*piece)+'px';
          p.style.width = piece+'px';
          p.style.height = piece+'px';
          p.style.backgroundPosition = `-${rx*piece}px -${ry*piece}px`;

          const spread = Math.max(120, rect.width*1.2);
          const dx = (rx - cols/2 + (Math.random()-.5))*spread;
          const dy = (ry - rows/2 + (Math.random()-.5))*spread - 40;
          const rot = (Math.random()*220 - 110)+'deg';
          p.style.setProperty('--dx', dx+'px');
          p.style.setProperty('--dy', dy+'px');
          p.style.setProperty('--rot', rot);
          p.style.animation = `blast ${rand(550, 900)}ms ease-out forwards`;

          document.body.appendChild(p);
          p.addEventListener('animationend', () => p.remove(), {once:true});
        }
      }
    }

    /* ---------- ‡∏•‡∏π‡∏õ‡πÄ‡∏Å‡∏° ---------- */
    function tick(now){
      const dt = Math.min(0.05, (now - lastTime)/1000);
      lastTime = now;

      document.querySelectorAll('.comet').forEach(node => {
        let x = parseFloat(node.dataset.x)||0;
        let y = parseFloat(node.dataset.y)||0;
        const vx = parseFloat(node.dataset.vx)||0;
        const vy = parseFloat(node.dataset.vy)||0;
        x += vx * dt; y += vy * dt;
        node.dataset.x = x; node.dataset.y = y;
        node.style.transform = `translate(calc(${x}px + var(--comet-offset-x)),
                                   calc(${y}px + var(--comet-offset-y)))`;

        const size = parseFloat(getComputedStyle(node).getPropertyValue('--size'))||100;
        if(y > window.innerHeight + size*1.5 || x < -size*1.5 || x > window.innerWidth + size*1.5){
          node.remove();
        }
      });

      if(running) requestAnimationFrame(tick);
    }

    /* ---------- ‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö/‡∏û‡∏±‡∏Å‡πÄ‡∏Å‡∏° ---------- */
    function clearScene(){
      [...document.querySelectorAll('.comet,.piece,.float')].forEach(el => el.remove());
    }

    function startGame(){
      running = true; ended = false; paused = false;
      overlay.classList.remove('show');

      score = 0; scoreEl.textContent = score;
      lastRunScore = 0;
      resetDecksForLevel();

      clickedWrongWords = [];
      if (wrongListEl) wrongListEl.innerHTML = '';
      if (wrongBoxEl)  wrongBoxEl.style.display = 'none';

      try{ if(bgm){ bgm.currentTime = 0; bgm.play().catch(()=>{}); } }catch(e){}

      remain = stageSeconds; timerEl.textContent = fmt(remain);
      if(countdown) clearInterval(countdown);
      countdown = setInterval(() => {
        if(!running) return;
        remain--; timerEl.textContent = fmt(remain);
        if(remain <= 0){ endGame('time'); }
      }, 1000);

      if(spawner) clearInterval(spawner);
      spawner = setInterval(spawnComet, SPAWN_MS);

      lastTime = performance.now();
      requestAnimationFrame(tick);
    }

    function endGame(reason='time'){
      if(ended) return;
      ended = true; running = false;
      clearInterval(countdown);
      clearInterval(spawner);

      lastRunScore = score;
      finalScoreEl.textContent = score.toString();
      endTitleEl.textContent = (reason==='win') ? '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô üéâ' : '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!';

      if (wrongListEl){
        if (clickedWrongWords.length === 0){
          if (wrongBoxEl) wrongBoxEl.style.display = 'none';
        } else {
          const seen = new Set();
          const unique = clickedWrongWords.filter(w => (seen.has(w) ? false : (seen.add(w), true)));
          wrongListEl.innerHTML = unique.map(w => `<span class="chip">${w}</span>`).join('');
          if (wrongBoxEl) wrongBoxEl.style.display = 'block';
        }
      }

      try{ if (winSound) { winSound.currentTime = 0; winSound.play().catch(()=>{}); } }catch(e){}
      try{ if(bgm){ bgm.pause(); bgm.currentTime = 0; } }catch(e){}

      overlay.classList.add('show');
    }

    function pauseGame(){
      if (!running) return;
      paused = true;
      running = false;
      clearInterval(countdown);
      clearInterval(spawner);
      try { if (bgm) bgm.pause(); } catch(e){}
      const pauseBtn = document.getElementById('pauseBtn');
      if (pauseBtn) pauseBtn.textContent = '‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠';
    }

    function resumeGame(){
      if (!paused || ended) return;
      paused = false;
      running = true;
      lastTime = performance.now();
      countdown = setInterval(() => {
        if(!running) return;
        remain--;
        timerEl.textContent = fmt(remain);
        if(remain <= 0){ endGame('time'); }
      }, 1000);
      spawner = setInterval(spawnComet, SPAWN_MS);
      requestAnimationFrame(tick);
      try { if (bgm) bgm.play().catch(()=>{}); } catch(e){}
      const pauseBtn = document.getElementById('pauseBtn');
      if (pauseBtn) pauseBtn.textContent = '‚è∏ ‡∏´‡∏¢‡∏∏‡∏î';
    }

    const pauseBtn = document.getElementById('pauseBtn');
    if(pauseBtn){
      pauseBtn.addEventListener('click', ()=>{
        if(!paused){ pauseGame(); pauseBtn.textContent = '‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠'; }
        else{ resumeGame(); pauseBtn.textContent = '‚è∏ ‡∏´‡∏¢‡∏∏‡∏î'; }
      });
    }

    // === Auto pause/resume ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö/‡∏û‡∏±‡∏ö‡πÅ‡∏≠‡∏õ ===
    let wasRunningBeforeHide = false;

    function uiBlockingOpen(){
      const landing = document.getElementById('landing');
      const startScreen = document.getElementById('startScreen');
      const guide = document.getElementById('guideScreen');
      const overlayOpen = overlay && overlay.classList.contains('show');
      const landingOpen = landing && !landing.classList.contains('hide');
      const startOpen   = startScreen && startScreen.style.display !== 'none';
      const guideOpen   = guide && getComputedStyle(guide).display !== 'none';
      return overlayOpen || landingOpen || startOpen || guideOpen;
    }

    function handleHidden(){
      wasRunningBeforeHide = running && !ended && !uiBlockingOpen();
      if (wasRunningBeforeHide) pauseGame();
    }

    function handleVisible(){
      if (wasRunningBeforeHide && paused && !ended && !uiBlockingOpen()){
        resumeGame();
      }
      wasRunningBeforeHide = false;
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) handleHidden(); else handleVisible();
    });
    window.addEventListener('blur', handleHidden);
    window.addEventListener('focus', handleVisible);
    window.addEventListener('pagehide', handleHidden);
    window.addEventListener('pageshow', handleVisible);

    const quickHome = document.getElementById('quickRestart');
    if(quickHome){ quickHome.addEventListener('click', ()=>{ location.reload(); }); }

    // ===== ‡∏õ‡∏∏‡πà‡∏° Overlay =====
    restartBtn.addEventListener('click', () => { clearScene(); startGame(); });

    selectLevelBtn.addEventListener('click', () => {
      overlay.classList.remove('show');
      clearScene();
      cumulativeScore = 0; roundsPlayed = 0; lastRunScore = 0; updateAccum();
      const landing = document.getElementById('landing');
      const startScreen = document.getElementById('startScreen');
      if (landing){ landing.classList.remove('hide'); }
      if (startScreen){ startScreen.style.display = 'none'; }
    });

    nextLevelBtn.addEventListener('click', () => {
      if (roundsPlayed < 2) {
        cumulativeScore += lastRunScore; roundsPlayed++; updateAccum();
        selectedLevel = (selectedLevel + 1) % LEVELS.length;
        overlay.classList.remove('show');
        openStartForLevel(true);
        return;
      }
      if (roundsPlayed === 2) {
        cumulativeScore += lastRunScore; roundsPlayed++; updateAccum();
        const sumEl = document.getElementById('accumSummary');
        const totalEl = document.getElementById('accumTotal');
        if (sumEl && totalEl){ totalEl.textContent = cumulativeScore.toString(); sumEl.style.display = 'block'; }
        endTitleEl.textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°';
        finalScoreEl.textContent = lastRunScore.toString();
        refreshNextButton();
        return;
      }
    });

    /* ---------- API ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ ---------- */
    window.__GAME__ = {
  startGame,
  setSelectedLevel: (i)=>{ selectedLevel = i|0; },
  getLevel: (i)=> LEVELS[i],
  getMissionFor: (i)=> (LEVELS[i] && LEVELS[i].mission) ? LEVELS[i].mission : '',
  hitComet
};

    /* ---------- ‡∏´‡∏°‡∏∏‡∏ô‡∏¢‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏≤‡∏™‡πå ---------- */
    (function(){
      const ship = document.getElementById('ship');
      if(!ship) return;
      const SHIP_OFFSET_DEG = 90;
      function rotateTo(x, y){
        const r = ship.getBoundingClientRect();
        const pivotX = r.left + r.width  * 0.5;
        const pivotY = r.top  + r.height * 0.75;
        const dx = x - pivotX, dy = y - pivotY;
        const deg = Math.atan2(dy, dx) * 180 / Math.PI;
        ship.style.transform = `translateX(-50%) rotate(${deg + SHIP_OFFSET_DEG}deg)`;
      }
      document.addEventListener('mousemove', (e) => rotateTo(e.clientX, e.clientY));
      rotateTo(window.innerWidth/2, window.innerHeight/2);

      window.__GAME__ = window.__GAME__ || {};
      window.__GAME__.pointShipAt = rotateTo;
      window.__GAME__.pointShipToNode = (el) => {
        if(!el) return;
        const rc = el.getBoundingClientRect();
        rotateTo(rc.left + rc.width/2, rc.top + rc.height/2);
      };
    })();

    /* ---------- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô (‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á) ---------- */
    const startScreen  = document.getElementById('startScreen');
    const startTitle   = document.getElementById('startTitle');
    const startBtn     = document.getElementById('startBtn');
    const countdownEl  = document.getElementById('countdown');

    function openStartForLevel(autoCountdown = true){
      const L = LEVELS[selectedLevel];
      if(startTitle){
        startTitle.textContent = (L.mission || `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${L.name}`);
      }
      if(startScreen) startScreen.style.display = 'flex';
      if(startBtn) startBtn.style.display = 'none';
      if(!autoCountdown) return;

      if(countdownEl){
        let n = 3;
        countdownEl.textContent = n; countdownEl.style.display = 'block';
        const itv = setInterval(() => {
          n--;
          if(n>0){ countdownEl.textContent = n; }
          else{
            clearInterval(itv);
            if(startScreen) startScreen.style.display = 'none';
            startGame();
          }
        }, 1000);
      }
    }

    if(startBtn){
      startBtn.addEventListener('click', () => {
        startBtn.style.display = 'none';
        let n = 3; countdownEl.textContent = n; countdownEl.style.display = 'block';
        const itv = setInterval(() => {
          n--;
          if(n>0){ countdownEl.textContent = n; }
          else{ clearInterval(itv); startScreen.style.display = 'none'; startGame(); }
        }, 1000);
      }, { once:true });
    }

    /* ---------- Landing + ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ---------- */
    (function(){
      const landing     = document.getElementById('landing');
      const levelBtns   = document.querySelectorAll('.levelBtn');
      const startScreen = document.getElementById('startScreen');
      const startTitle  = document.getElementById('startTitle');

      levelBtns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = parseInt(btn.getAttribute('data-level'),10);
          if (Number.isNaN(idx)) return;

          if(window.__GAME__ && window.__GAME__.setSelectedLevel){
            window.__GAME__.setSelectedLevel(idx);
          }
          const L = (window.__GAME__ && window.__GAME__.getLevel) ? window.__GAME__.getLevel(idx) : null;
          startTitle.textContent = ((L && L.mission) ? L.mission : `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${btn.textContent}`);

          landing.classList.add('hide');
          startScreen.style.display = 'flex';
          const startBtn = document.getElementById('startBtn');
          if(startBtn){ startBtn.style.display = 'inline-block'; }
          const countdownEl = document.getElementById('countdown');
          if(countdownEl){ countdownEl.style.display = 'none'; }
        });
      });

      const guideBtn  = document.getElementById('guideBtn');
      const guide     = document.getElementById('guideScreen');
      const guideBack = document.getElementById('guideBack');

      if (guideBtn && guide){
        guideBtn.addEventListener('click', ()=>{
          landing.classList.add('hide');
          guide.style.display = 'flex';
        });
      }
      if (guideBack && guide){
        guideBack.addEventListener('click', ()=>{
          guide.style.display = 'none';
          landing.classList.remove('hide');
        });
      }
    })();

  })();
  </script>
<script>
(function(){
  const micBtn   = document.getElementById('micBtn');
  const voicePill= document.getElementById('voicePill');
  if(!micBtn) return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    micBtn.textContent = 'üé§ ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
    micBtn.disabled = true;
    return;
  }

  let askedOnce = false;
  let keepListening = false;
  let recognizing = false;

  const rec = new SR();
  rec.lang = 'th-TH';
  rec.continuous = true;
  rec.interimResults = true;

  function showListening(on){
    micBtn.textContent = on ? 'üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î' : 'üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î';
    if(voicePill) voicePill.style.display = on ? 'inline-block' : 'none';
  }

  // ‡πÅ‡∏ï‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢: ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏à‡∏≠
  function tokensFrom(s){
    s = (s||'').toLowerCase().trim();
    s = s.replace(/\s*(‡∏Ñ‡πà‡∏∞|‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡∏∞|‡∏Æ‡∏∞)$/,'');     // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏≤‡∏û
    return s.split(/[\s,Ôºå„ÄÇ\.!?:;„ÄÅ]+/).filter(Boolean);
  }

  function currentCometsMap(){
    const map = new Map();
    document.querySelectorAll('.comet').forEach(n=>{
      const label = (n.querySelector('.label')?.textContent||'').trim().toLowerCase();
      if(!label) return;
      if(!map.has(label)) map.set(label, []);
      map.get(label).push(n);
    });
    return map;
  }
  function pickLowest(arr){
    return arr.reduce((best,n)=>{
      const y = parseFloat(n.dataset.y)||0;
      return (!best || y > (parseFloat(best.dataset.y)||0)) ? n : best;
    }, null);
  }
  function centerOf(node){
    const r = node.getBoundingClientRect();
    return { x: r.left + r.width/2, y: r.top + r.height/2 };
  }

  function tryFire(phrase){
    const toks = tokensFrom(phrase);
    if(!toks.length) return false;

    const cmap = currentCometsMap();
    for(const t of toks){
      if(cmap.has(t)){
        const node = pickLowest(cmap.get(t));
        if(node && !node.dataset.hit){
          const c = centerOf(node);
          window.__GAME__?.hitComet(node, c.x, c.y); // ‡∏¢‡∏¥‡∏á‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å
          return true;
        }
      }
    }
    return false;
  }

  rec.onresult = (e) => {
    for(let i=e.resultIndex; i<e.results.length; i++){
      const r = e.results[i];
      const txt = (r[0]?.transcript || '').trim();
      if(!txt) continue;
      // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á interim ‡πÅ‡∏•‡∏∞ final ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå"
      tryFire(txt);
    }
  };
  rec.onstart = () => { recognizing = true; showListening(true); };
  rec.onend   = () => {
    recognizing = false; showListening(false);
    if(keepListening && !document.hidden){
      setTimeout(()=>{ try{ rec.start(); }catch(_){} }, 200);
    }
  };
  rec.onerror = (e) => {
    // no-speech/aborted/audio-capture = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if(e?.error === 'not-allowed'){
      micBtn.textContent = 'üé§ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
      micBtn.disabled = true;
    }
  };

  async function ensureMicPermissionOnce(){
    if(askedOnce) return;
    askedOnce = true;
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      // ‡∏õ‡∏¥‡∏î track ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
      stream.getTracks().forEach(t=>t.stop());
    }catch(_){
      micBtn.textContent = 'üé§ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
      micBtn.disabled = true;
      throw _;
    }
  }

  function startListen(){
    keepListening = true;
    try{ rec.start(); }catch(_){}
  }
  function stopListen(){
    keepListening = false;
    try{ rec.stop(); }catch(_){}
  }

  micBtn.addEventListener('click', async ()=>{
    if(keepListening){ stopListen(); return; }
    try{
      await ensureMicPermissionOnce();
      startListen();
    }catch(_){}
  });

  // ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πá‡∏ö ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏≠‡∏á
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){
      if(recognizing) try{ rec.stop(); }catch(_){}
    }else if(keepListening){
      setTimeout(()=>{ try{ rec.start(); }catch(_){} }, 150);
    }
  });
})();
</script>

<!-- ===== Head-Only AR: ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å + ‡∏ä‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πá‡∏ï ===== -->
<script>
(function(){
  const camBtn = document.getElementById('camBtn');
  const video  = document.getElementById('cameraMirror');
  const hcv    = document.getElementById('headCanvas');
  if(!camBtn || !video || !hcv) return;

  /* ===== ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á ===== */
  const ALPHA = 0.38;         // smoothing (EMA)
  const VIS_THR = 0.6;        // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå visibility ‡∏Ç‡∏≠‡∏á landmark
  const RADIUS_MIN = 24, RADIUS_MAX = 56;
  const DEBOUNCE_MS = 120;    // ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô

  /* ===== ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ===== */
  let stream = null;
  let askedOnce = false;
  let running = false;        // loop ‡∏™‡πà‡∏á‡πÄ‡∏ü‡∏£‡∏°‡πÉ‡∏´‡πâ pose
  let pose = null;            // ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≤
  let lastLandmarks = null;
  let smooth = null;          // {x,y,r} ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô
  let lastHitAt = 0;

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° canvas
  const hctx = hcv.getContext('2d', { alpha:true });
  function fitCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    hcv.width  = Math.round(window.innerWidth * dpr);
    hcv.height = Math.round(window.innerHeight * dpr);
    hcv.style.width  = window.innerWidth + 'px';
    hcv.style.height = window.innerHeight + 'px';
    hctx.setTransform(1,0,0,1,0,0);
    hctx.scale(dpr, dpr);
  }
  fitCanvas();
  window.addEventListener('resize', fitCanvas);

  // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á crop ‡πÅ‡∏ö‡∏ö cover + mirror (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ô‡∏à‡∏≠)
  function coverCropRect(){
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 480;
    const sw = window.innerWidth, sh = window.innerHeight;
    const scale = Math.max(sw / vw, sh / vh);
    const sW = Math.round(sw / scale);
    const sH = Math.round(sh / scale);
    const sX = Math.round((vw - sW)/2);
    const sY = Math.round((vh - sH)/2);
    return {vw,vh, sw,sh, sX,sY,sW,sH};
  }
  function mapNormToScreen(nx, ny){
    const {vw,vh, sw,sh, sX,sY,sW,sH} = coverCropRect();
    const xInCrop = nx*vw - sX;
    const yInCrop = ny*vh - sY;
    let x = (xInCrop / sW) * sw;
    let y = (yInCrop / sH) * sh;
    // mirror (‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÇ‡∏î‡∏ô scaleX(-1))
    x = sw - x;
    return {x, y};
  }

  // ‡πÇ‡∏´‡∏•‡∏î MediaPipe Pose ‡πÅ‡∏ö‡∏ö dynamic ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
async function ensurePose(){
  if (window.__POSE_READY__) return;     // ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
  // ==== ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå ====
  const loadScript = (src) => new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onload = () => res();
    s.onerror = () => rej(new Error('load fail: '+src));
    document.head.appendChild(s);
  });

  // ==== ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ) ====
  const POSE_BASES = [
    'https://cdn.jsdelivr.net/npm/@mediapipe/pose',   // ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å (‡∏≠‡∏≤‡∏à‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å)
    'https://unpkg.com/@mediapipe/pose',              // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà 1
    './libs/mediapipe/pose'                           // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà 2 (‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
  ];
  const CAM_BASES = [
    'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils',
    'https://unpkg.com/@mediapipe/camera_utils',
    './libs/mediapipe/camera_utils'
  ];

  let poseBase = null;
// (1) camera_utils: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á" ‡πÇ‡∏¢‡∏ô‡∏ó‡∏¥‡πâ‡∏á
let camLoaded = false;
for (const base of CAM_BASES){
  try { await loadScript(`${base}/camera_utils.js`); camLoaded = true; break; } catch(e){}
}
if (!camLoaded) console.warn('camera_utils ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ');

// (2) pose.js: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≠‡∏¢ throw
let poseBase = null;
for (const base of POSE_BASES){
  try {
    await loadScript(`${base}/pose.js`);
    poseBase = base;
    break;
  } catch(e){}
}
if (!poseBase) throw new Error('‡πÇ‡∏´‡∏•‡∏î pose.js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á');

// (3) ‡∏ï‡∏£‡∏ß‡∏à global ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏Å‡πà‡∏≠‡∏ô new
if (!(window.Pose && window.Pose.Pose)) {
  throw new Error('‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global Pose ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î pose.js');
}

const p = new Pose.Pose({
  locateFile: (f) => `${poseBase}/${f}`
});
p.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});
p.onResults(res => {
  window.__LAST_LANDMARKS__ = (res && res.poseLandmarks && res.poseLandmarks.length) ? res.poseLandmarks : null;
});

window.__POSE_INSTANCE__ = p;
window.__POSE_READY__ = true;
  });
  p.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  p.onResults(res => {
    window.__LAST_LANDMARKS__ = (res && res.poseLandmarks && res.poseLandmarks.length) ? res.poseLandmarks : null;
  });

  // ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
  window.__POSE_INSTANCE__ = p;
  window.__POSE_READY__ = true;
}

  // ‡∏≠‡∏ô‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏à‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å‡∏à‡∏≤‡∏Å ‚Äú‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≤‚Äù
  function eyeForeheadFromPose(L){
    // index ‡∏ä‡∏∏‡∏î BlazePose: 2=left_eye, 5=right_eye, 11=ls, 12=rs, 0=nose
    const le=L[2], re=L[5], ls=L[11], rs=L[12];
    if(!le||!re||!ls||!rs) return null;
    if((le.visibility??1)<VIS_THR || (re.visibility??1)<VIS_THR) return null;

    const mid = { x:(le.x+re.x)/2, y:(le.y+re.y)/2 };
    const eyeDist = Math.hypot(le.x-re.x, le.y-re.y);
    const shoulderMid = { x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2 };

    // ‡∏ó‡∏¥‡∏®‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏õ‡∏´‡∏±‡∏ß (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏´‡∏±‡∏ß)
    let ux = mid.x - shoulderMid.x, uy = mid.y - shoulderMid.y;
    const len = Math.hypot(ux,uy) || 1; ux/=len; uy/=len;

    // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô ~0.25√óeyeDist ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å
    const fx = mid.x + ux * (-0.25 * eyeDist);
    const fy = mid.y + uy * (-0.25 * eyeDist);
    return { forehead:{x:fx, y:fy}, eyeDist };
  }

  function ema(prev, next, a){
    if(!prev) return next;
    return { x: prev.x + a*(next.x - prev.x),
             y: prev.y + a*(next.y - prev.y),
             r: prev.r + a*(next.r - prev.r) };
  }

  function drawCircle(x,y,r){
    hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    // glow
    hctx.beginPath(); hctx.arc(x,y,r,0,Math.PI*2);
    hctx.globalAlpha=0.25; hctx.lineWidth=Math.max(6, r*0.45);
    hctx.strokeStyle='#ffffff'; hctx.shadowColor='#ffffff'; hctx.shadowBlur=22; hctx.stroke();
    // core
    hctx.beginPath(); hctx.arc(x,y,r,0,Math.PI*2);
    hctx.globalAlpha=0.95; hctx.lineWidth=Math.max(3, r*0.2);
    hctx.strokeStyle='#ffffff'; hctx.shadowBlur=0; hctx.stroke();
    hctx.globalAlpha=1;
  }

  function circleHitsRect(cx,cy,r, rc){
    const nx = Math.max(rc.left, Math.min(cx, rc.right));
    const ny = Math.max(rc.top,  Math.min(cy, rc.bottom));
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= (r*r);
  }
  let lastShipAimAt = 0;
  function aimShipThrottled(x,y){
    const t=performance.now();
    if(t-lastShipAimAt<20) return;
    lastShipAimAt=t;
    try{ window.__GAME__?.pointShipAt?.(x,y); }catch(e){}
  }

  function hitComets(cx,cy,r){
    const now = performance.now();
    if(now - lastHitAt < DEBOUNCE_MS) return;
    const nodes = document.querySelectorAll('.comet');
    for(const node of nodes){
      if(node.dataset.hit) continue;
      const rc = node.getBoundingClientRect();
      if(circleHitsRect(cx,cy,r, rc)){
        window.__GAME__?.hitComet(node, rc.left+rc.width/2, rc.top+rc.height/2);
        lastHitAt = now;
        break;
      }
    }
  }

  async function loop(){
    if(!running || !video.videoWidth){ requestAnimationFrame(loop); return; }
    try{ await pose.send({image: video}); }catch(_){}
    const L = window.__LAST_LANDMARKS__;

    if(L){
      const info = eyeForeheadFromPose(L);
      if(info){
        const p = mapNormToScreen(info.forehead.x, info.forehead.y);
        let r = Math.max(RADIUS_MIN, Math.min(RADIUS_MAX, info.eyeDist * window.innerWidth * 0.35));
        smooth = ema(smooth, {x:p.x,y:p.y,r}, ALPHA);
        drawCircle(smooth.x, smooth.y, smooth.r);
        aimShipThrottled(smooth.x, smooth.y);
        hitComets(smooth.x, smooth.y, smooth.r);
      }else{
        hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
    }else{
      hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }
    requestAnimationFrame(loop);
  }

  /* ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏õ‡∏∏‡πà‡∏° üì∑) ===== */
 async function startCamera(){
  if (running) return;

  // 0) ‡πÄ‡∏ä‡πá‡∏Ñ API
  if (!navigator.mediaDevices?.getUserMedia) {
    camBtn.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
    alert('‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS/localhost ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö getUserMedia');
    return;
  }

  // 1) ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á "‡∏Å‡πà‡∏≠‡∏ô" ‡πÄ‡∏™‡∏°‡∏≠
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
  } catch (err) {
    console.error('getUserMedia error:', err);
    const reason =
      err?.name === 'NotAllowedError' ? '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á' :
      err?.name === 'NotFoundError'   ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' :
      err?.name === 'NotReadableError'? '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô' :
      err?.message || String(err);
    camBtn.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + reason);
    return;
  }

  // 2) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏£‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•)
  video.muted = true;
  video.srcObject = stream;
  await new Promise(res => {
    if (video.readyState >= 1) res();
    else video.onloadedmetadata = () => res();
  });
  try { await video.play(); } catch(_) {}
  video.style.display = 'block';
  hcv.style.display   = 'block';
  camBtn.textContent  = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î';
  running = true;
  smooth = null;
  requestAnimationFrame(loop);    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÑ‡∏ß‡πâ ‡∏ñ‡∏∂‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πá‡πÅ‡∏Ñ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°

  // 3) ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• Pose ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  ensurePose()
    .catch(err => {
      console.warn('‡πÇ‡∏´‡∏•‡∏î Pose ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
      // ‚ùó ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î stream ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
      camBtn.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß)';
      // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    });
}


  function stopCamera(){
    running = false;

    // 1) ‡∏´‡∏¢‡∏∏‡∏î track ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    // 2) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå srcObject ‚Äú‡πÅ‡∏ö‡∏ö property‚Äù (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£ removeAttribute)
    try { video.srcObject = null; } catch(_) {}

    // 3) ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå + ‡∏•‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û
    video.pause();
    video.style.display = 'none';
    hcv.style.display   = 'none';
    smooth = null;
    hctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

    camBtn.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏õ‡∏¥‡∏î';
  }


  camBtn.addEventListener('click', async ()=>{
    if(!running){ try{ await startCamera(); }catch(_){} }
    else{ stopCamera(); }
  });

  // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πá‡∏ö
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden && running) stopCamera();
  });

})();
</script>

<!-- ===== Head-Circle Mode: ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≤ ===== -->
<script>
(function(){
  const headBtn = document.getElementById('headBtn');
  const video   = document.getElementById('cameraMirror');
  const hcv     = document.getElementById('headCanvas');
  if(!headBtn || !video || !hcv) return;

  // ---------- ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö ----------
  const ALPHA = 0.38;          // EMA smoothing
  const VIS_THR = 0.6;         // visibility ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á landmark ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  const RADIUS_MIN = 24, RADIUS_MAX = 56;
  const DEBOUNCE_MS = 120;     // ‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô

  // ---------- ‡∏™‡∏†‡∏≤‡∏ß‡∏∞ ----------
  let headMode = false;        // false=‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå, true=‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏±‡∏ß
  let running  = false;        // loop ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
  let pose     = null;         // ‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≤ (‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö on-demand)
  let smooth = null;           // ‡∏à‡∏∏‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô {x,y,r}
  let lastHitAt = 0;

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° canvas
  const hctx = hcv.getContext('2d', { alpha:true });
  function fitHeadCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    hcv.width  = Math.round(window.innerWidth * dpr);
    hcv.height = Math.round(window.innerHeight * dpr);
    hcv.style.width  = window.innerWidth + 'px';
    hcv.style.height = window.innerHeight + 'px';
    hctx.setTransform(1,0,0,1,0,0);
    hctx.scale(dpr, dpr);
  }
  fitHeadCanvas();
  window.addEventListener('resize', fitHeadCanvas);

  // ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö cover (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°) + mirror
  function coverCropRect(){
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 480;
    const sw = window.innerWidth, sh = window.innerHeight;
    const scale = Math.max(sw / vw, sh / vh);
    const sW = Math.round(sw / scale);
    const sH = Math.round(sh / scale);
    const sX = Math.round((vw - sW)/2);
    const sY = Math.round((vh - sH)/2);
    return {vw,vh, sw,sh, sX,sY,sW,sH};
  }
  function mapNormToScreen(nx, ny){
    // nx,ny: 0..1 ‡πÉ‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    const {vw,vh, sw,sh, sX,sY,sW,sH} = coverCropRect();
    const xInCrop = nx*vw - sX;
    const yInCrop = ny*vh - sY;
    let x = (xInCrop / sW) * sw;
    let y = (yInCrop / sH) * sh;
    // mirror ‡∏ï‡∏≤‡∏° CSS ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    x = sw - x;
    return {x, y};
  }

  // ‡πÇ‡∏´‡∏•‡∏î MediaPipe Pose ‡πÅ‡∏ö‡∏ö dynamic (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
  async function ensurePoseLoaded(){
    if(pose) return;
    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏≤‡∏Å CDN ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ (solutions classic)
    const load = (src)=> new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
    await load('https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js');
    await load('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'); // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô camera utils

    pose = new Pose.Pose({
      locateFile: (f)=> `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });
  }

  function eyeCenterAndDist(landmarks){
    // BlazePose index (‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ): 2=left_eye, 5=right_eye, 11=ls, 12=rs
    const L = landmarks;
    const le = L[2], re = L[5], ls = L[11], rs = L[12], nose = L[0];
    if(!le||!re||!ls||!rs||!nose) return null;
    if((le.visibility??1)<VIS_THR || (re.visibility??1)<VIS_THR) return null;

    // ‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≤ (‡πÉ‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î normalized 0..1)
    const mid = { x:(le.x+re.x)/2, y:(le.y+re.y)/2 };
    const eyeDist = Math.hypot(le.x - re.x, le.y - re.y);

    // ‡∏ó‡∏¥‡∏® "‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏´‡∏±‡∏ß": ‡πÑ‡∏´‡∏•‡πà‡∏Å‡∏•‡∏≤‡∏á ‚Üí ‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≤
    const shoulderMid = { x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2 };
    let ux = mid.x - shoulderMid.x, uy = mid.y - shoulderMid.y;
    const len = Math.hypot(ux,uy) || 1;
    ux/=len; uy/=len;

    // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 0.25√ó‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏≤-‡∏ï‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å
    const fx = mid.x + ux * ( -0.25 * eyeDist ); // ‡∏•‡∏ö‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏Å‡∏ô y ‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á
    const fy = mid.y + uy * ( -0.25 * eyeDist );

    return { mid, eyeDist, forehead:{x:fx, y:fy} };
  }

  function ema(prev, next, a){
    if(!prev) return next;
    return { x: prev.x + a*(next.x - prev.x),
             y: prev.y + a*(next.y - prev.y),
             r: prev.r + a*(next.r - prev.r) };
  }

  function drawCircle(x,y,r){
    hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    // glow outer
    hctx.beginPath();
    hctx.arc(x,y,r,0,Math.PI*2);
    hctx.globalAlpha = 0.25;
    hctx.lineWidth = Math.max(6, r*0.45);
    hctx.strokeStyle = '#ffffff';
    hctx.shadowColor = '#ffffff';
    hctx.shadowBlur = 22;
    hctx.stroke();
    // core ring
    hctx.beginPath();
    hctx.arc(x,y,r,0,Math.PI*2);
    hctx.globalAlpha = 0.95;
    hctx.lineWidth = Math.max(3, r*0.2);
    hctx.strokeStyle = '#ffffff';
    hctx.shadowBlur = 0;
    hctx.stroke();
    hctx.globalAlpha = 1;
  }

  function circleHitsRect(cx,cy,r, rc){
    const nx = Math.max(rc.left, Math.min(cx, rc.right));
    const ny = Math.max(rc.top,  Math.min(cy, rc.bottom));
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) <= (r*r);
  }

  function tryHitComets(cx,cy,r){
    const now = performance.now();
    if(now - lastHitAt < DEBOUNCE_MS) return;
    const nodes = document.querySelectorAll('.comet');
    for(const node of nodes){
      if(node.dataset.hit) continue;
      const rc = node.getBoundingClientRect();
      if(circleHitsRect(cx,cy,r, rc)){
        window.__GAME__?.hitComet(node, rc.left + rc.width/2, rc.top + rc.height/2);
        lastHitAt = now;
        break;
      }
    }
  }

  // loop ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å pose.send(image) ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ü‡∏£‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ú‡πà‡∏≤‡∏ô callback
  let lastLandmarks = null;
  function setupPoseCallback(){
    if(!pose) return;
    pose.onResults(res=>{
      lastLandmarks = (res && res.poseLandmarks && res.poseLandmarks.length) ? res.poseLandmarks : null;
    });
  }

  async function loop(){
    if(!running || !video.videoWidth) { requestAnimationFrame(loop); return; }
    // ‡∏™‡πà‡∏á‡πÄ‡∏ü‡∏£‡∏°‡πÉ‡∏´‡πâ pose ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    try{ await pose.send({image: video}); }catch(e){ /* ‡πÄ‡∏ü‡∏£‡∏°‡∏ï‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ */ }

    const L = lastLandmarks;
    if(headMode && L){
      const inf = eyeCenterAndDist(L);
      if(inf){
        const {forehead, eyeDist} = inf;
        // map ‚Üí screen
        const p = mapNormToScreen(forehead.x, forehead.y);
        // ‡∏™‡πÄ‡∏Å‡∏•‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏≤
        let r = Math.max(RADIUS_MIN, Math.min(RADIUS_MAX, eyeDist * window.innerWidth * 0.35));
        const target = {x:p.x, y:p.y, r};
        smooth = ema(smooth, target, ALPHA);

        // ‡∏´‡∏°‡∏∏‡∏ô‡∏¢‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß (‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå)
        try{ window.__GAME__?.pointShipAt?.(smooth.x, smooth.y); }catch(e){}

        // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏° + ‡∏ä‡∏ô
        drawCircle(smooth.x, smooth.y, smooth.r);
        tryHitComets(smooth.x, smooth.y, smooth.r);
      }else{
        hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
    }else{
      // ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß ‚Üí ‡πÑ‡∏°‡πà‡∏ß‡∏≤‡∏î
      hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    }

    requestAnimationFrame(loop);
  }

  // ------------ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏´‡∏°‡∏î/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ------------
  async function enableHeadMode(on){
    headMode = !!on;
    headBtn.textContent = headMode ? 'üß† ‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏±‡∏ß' : 'üß† ‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå';
    // ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™
    const camCanvas = document.getElementById('camCanvas');
    if(headMode){
      hcv.style.display = 'block';
      if(camCanvas) camCanvas.style.display = 'none';  // ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      if(!pose){ await ensurePoseLoaded(); setupPoseCallback(); }
      if(!running){ running = true; requestAnimationFrame(loop); }
    }else{
      hcv.style.display = 'none';
      if(camCanvas && video.srcObject) camCanvas.style.display = 'block'; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
    }
  }

  headBtn.addEventListener('click', ()=> enableHeadMode(!headMode));

  // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå
  window.addEventListener('ar-camera-start', ()=>{
    if(headMode){
      hcv.style.display = 'block';
      if(!running){ running = true; requestAnimationFrame(loop); }
    }
  });
  window.addEventListener('ar-camera-stop', ()=>{
    hcv.style.display = 'none';
    // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î running ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß ‡πÅ‡∏ï‡πà‡∏•‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û
    hctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    smooth = null;
  });

})();
</script>

</body>
</html>

